## Day8

#### 鼠标瞬移

在编写mouse_decode函数时，我想要尽可能的简化处理过程，书中源码如下所示：

```C
int mouse_decode(struct MOUSE_DEC *mdec, unsigned char dat)
{
	if (mdec->phase == 0)
    {
        if (dat == 0xfa)
            mdec->phase = 1;
        return 0;
    }
	if (mdec->phase == 1) 
    {
        mdec->phase = 2;
        ...
    }
	if (mdec->phase == 2)
    {
        mdec->phase = 3;
        ...
    }
	if (mdec->phase == 3)
    {
        ...
        mdec->phase = 1;
        ...
    }
	return -1;
}
```

其中第一个if判断块的主要功能是，当dat值为0xfa时，才会进入下一个阶段。

但是在阅读原书的过程中，读到下面这句话："一直等着机会露脸的鼠标先生，收到激活指令以后，马上就给CPU发送答复信息：`OK，从现在开始就要不停地发送鼠标信息了，拜托了。`这个答复信息就是0xfa。"

在我看来，这句话的意思是，0xfa仅仅在鼠标启动时才会发送。而且从mouse_decode这个处理函数中也可以看到，一旦phase值为1，那么就再也不用回到第0阶段。所以我觉得，0xfa我大可直接忽略掉，直接开始处理三元组数据。

具体的处理函数如下所示：

```C
int mouse_decode(struct MOUSE_DEC *mdec, unsigned char dat)
{
    if (dat == 0xfa)
        return 0;
	
	if (mdec->phase == 0) 
    {
        mdec->phase = 1;
        ...
	}
	if (mdec->phase == 1)
    {
        mdec->phase = 2;
        ...
    }
	if (mdec->phase == 2)
    {
        ...
        mdec->phase = 0;
        ...
    }
	return -1;
}
```

<font color=darkorange>但是这种处理方法在运行过程中会出现鼠标瞬移的现象。</font>

观察鼠标的瞬移发现瞬移仅发生以下两种情况：

1. 突然瞬移到最左边 → x归0
2. 突然瞬移到最下方 → y变为最大值

而且不管鼠标移动的多慢，一旦触发就会直接瞬移到边界，并且每次触发的坐标不固定



观察代码，并提出下面几种假设：

1. `buf[0] & 0x10 != 0`导致x值被置为0，y读取错误
2. x与y本身读取错误

个人更偏向于二者的结合，即三个元素全部都出现了错误。



既然是数据读取错误，那可能是什么错误呢？

在我的代码中，`0xfa`在开头即被处理，因此不可能读入`0xfa`，而`0xfa = 250`。所以考虑到一种情况，如果`dat = 0xfa`并不是响应的值，而是鼠标所发送的三元组中的一个值，那么这个数据的处理会被直接跳过，导致错误发生。

为了测试上述可能，把对0xfa的处理删除，并在打开鼠标后等待一会儿（确保KBC已经将确认信息发送到CPU）。

问题被解决。



#### 鼠标移速慢——数据处理速度慢【TODO】

上述修改方法确实有效地解决了鼠标瞬移的现象，但是依然存在一个问题，就是数据处理的速度过慢了，比书中的实现要慢很多，这很不正常。

发现是因为使用`if...else...`来对鼠标的状态进行处理，而不是多个`if`的组合。

为什么会慢？难道`if...else...`不如多个`if`的组合？

找不到答案，可能是与汇编的实现方式有关系，以后再探究



## Day10

#### 无法显示sheet

`sheet_setbuf()`初始化代码错误，将`bxsize`与`bysize`设置到了`vx0`与`vy0`上



#### 鼠标无法移动，无法显示主界面输出内容

1. 将mouse的buffer设置到了`shtback`上，使得背景无法显示

修改了上述问题后可以显示背景，但是依然无法移动鼠标，观察后发现似乎没有进入鼠标坐标更新代码中

发现是因为访问了`shtctl`的内存才会导致无法更新鼠标



#### 鼠标无法移动，当键盘刷新时才会被刷新
`sheet_refreshsub`函数`h`初始化错误





